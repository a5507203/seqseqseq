<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Learn & Explore – Quiz-Gated Metroidvania</title>
  <style>
    /* Reset and full-screen canvas */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #222; }
    #gameCanvas { display: block; background: #87CEEB; }
    /* Quiz Overlay Styling */
    #quizOverlay {
      position: absolute; 
      top: 0; left: 0;
      width: 100%; 
      height: 100%;
      background: rgba(0,0,0,0.7);
      color: #fff; 
      font-family: sans-serif;
      display: none;
      align-items: center; 
      justify-content: center;
    }
    #quizBox {
      background: #333;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
    }
    #quizBox h2 { margin-bottom: 10px; }
    .choice { margin: 8px 0; }
    button { margin-top: 12px; padding: 6px 12px; }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="450"></canvas>
  <div id="quizOverlay">
    <div id="quizBox">
      <h2 id="quizTitle">Quiz Time!</h2>
      <div id="quizQuestion">Question text...</div>
      <div id="choices"></div>
      <button id="submitAnswer">Submit</button>
    </div>
  </div>

  <script>
    // Canvas & context
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const width = canvas.width, height = canvas.height;

    // Player state
    const player = {
      x: 50, 
      y: height - 100, 
      w: 32, 
      h: 48,
      dx: 0, 
      dy: 0,
      speed: 2.5, 
      jumpStrength: 7,
      onGround: false, 
      jumpCount: 0,
      abilities: { fire: false, ice: false, doubleJump: false }
    };

    // Input Handling
    const keys = {};
    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup',   e => keys[e.key] = false);

    // Level definition: platforms, gates, and quiz orbs
    const platforms = [
      { x: 0, y: height - 50, w: width, h: 50 },
      { x: 150, y: 300, w: 200, h: 20 },
      { x: 450, y: 250, w: 150, h: 20 }
    ];
    const gates = [
      { x: 350, y: height - 100, w: 20, h: 50, type: 'fire', locked: true },
      { x: 600, y: height - 100, w: 20, h: 50, type: 'ice', locked: true },
      { x: 700, y: height - 150, w: 20, h: 100, type: 'doubleJump', locked: true }
    ];
    const orbs = [
      { x: 200, y: 270, r: 10, subject: 'math', taken: false },
      { x: 500, y: 220, r: 10, subject: 'history', taken: false },
      { x: 650, y: 220, r: 10, subject: 'science', taken: false }
    ];

    // Collision Helper Functions
    function rectIntersect(a, b) {
      return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
    }
    function circleRect(cx, cy, r, rect) {
      const cxClamped = Math.max(rect.x, Math.min(cx, rect.x + rect.w));
      const cyClamped = Math.max(rect.y, Math.min(cy, rect.y + rect.h));
      const dx = cx - cxClamped, dy = cy - cyClamped;
      return dx * dx + dy * dy < r * r;
    }

    // Quiz overlay elements
    const quizOverlay = document.getElementById('quizOverlay');
    const submitBtn = document.getElementById('submitAnswer');

    // Question Bank for quizzes
    const questionBank = {
      math: [
        { q: "What is 7 × 6?", choices: ["36", "42", "48", "56"], answer: 1 },
        { q: "√81 = ?", choices: ["7", "8", "9", "10"], answer: 2 },
        { q: "15 + 28 = ?", choices: ["43", "45", "42", "44"], answer: 0 },
        { q: "100 ÷ 4 = ?", choices: ["20", "25", "15", "30"], answer: 1 },
        { q: "2^5 = ?", choices: ["16", "32", "64", "8"], answer: 1 }
      ],
      history: [
        { q: "1st U.S. President?", choices: ["Lincoln", "Washington", "Jefferson", "Adams"], answer: 1 },
        { q: "WWII ended in?", choices: ["1945", "1939", "1918", "1963"], answer: 0 },
        { q: "Great Wall is in?", choices: ["India", "China", "Japan", "Korea"], answer: 1 }
      ],
      science: [
        { q: "Red Planet?", choices: ["Mars", "Venus", "Jupiter", "Saturn"], answer: 0 },
        { q: "H2O is?", choices: ["Salt", "Water", "Ammonia", "Hydrogen"], answer: 1 },
        { q: "Plants absorb?", choices: ["Oxygen", "Nitrogen", "CO₂", "Helium"], answer: 2 }
      ]
    };

    // Quiz state and mapping subjects to abilities
    let currentQuestions = [], currentIndex = 0, score = 0, activeOrb = null;
    const abilityMap = { math: 'doubleJump', history: 'fire', science: 'ice' };

    function startQuiz(subject, orb) {
      // Randomly select 3 questions from the subject bank
      const bank = [...questionBank[subject]];
      currentQuestions = bank.sort(() => 0.5 - Math.random()).slice(0, 3);
      currentIndex = 0; 
      score = 0; 
      activeOrb = orb;
      quizOverlay.style.display = 'flex';
      showQuestion();
    }

    function showQuestion() {
      const qObj = currentQuestions[currentIndex];
      document.getElementById('quizQuestion').innerText = qObj.q;
      const choicesDiv = document.getElementById('choices');
      choicesDiv.innerHTML = '';
      qObj.choices.forEach((choice, i) => {
        const id = `choice${i}`;
        const wrapper = document.createElement('div');
        wrapper.className = 'choice';
        wrapper.innerHTML = `<input type="radio" name="quizChoice" id="${id}" value="${i}"> <label for="${id}">${choice}</label>`;
        choicesDiv.appendChild(wrapper);
      });
    }

    submitBtn.addEventListener('click', () => {
      const sel = document.querySelector('input[name="quizChoice"]:checked');
      if (!sel) {
        alert('Please select an answer.');
        return;
      }
      if (parseInt(sel.value) === currentQuestions[currentIndex].answer) {
        score++;
      }
      currentIndex++;
      if (currentIndex < 3) {
        showQuestion();
      } else {
        quizOverlay.style.display = 'none';
        if (score === 3) {
          const ability = abilityMap[activeOrb.subject];
          player.abilities[ability] = true;
          // Unlock corresponding gates
          gates.forEach(g => {
            if (g.type === ability) {
              g.locked = false;
            }
          });
        } else {
          // If failed, allow retry later
          activeOrb.taken = false;
        }
        activeOrb = null;
      }
    });

    // Game update and drawing routines
    function update() {
      if (quizOverlay.style.display === 'flex') return; // Pause game during quiz

      // Player horizontal movement
      player.dx = 0;
      if (keys['ArrowLeft'] || keys['a']) player.dx = -player.speed;
      if (keys['ArrowRight'] || keys['d']) player.dx = player.speed;

      // Jump and Double Jump logic
      if (keys['ArrowUp'] || keys['w']) {
        if (player.onGround) {
          player.dy = -player.jumpStrength;
          player.onGround = false;
          player.jumpCount = 1;
        } else if (player.abilities.doubleJump && player.jumpCount === 1) {
          player.dy = -player.jumpStrength;
          player.jumpCount = 2;
        }
      }
      
      // Apply gravity
      player.dy += 0.35;
      player.x += player.dx;
      player.y += player.dy;

      // Collision with platforms and ground
      player.onGround = false;
      const pBox = { x: player.x, y: player.y, w: player.w, h: player.h };
      platforms.forEach(pl => {
        if (rectIntersect(pBox, pl) && player.dy >= 0) {
          player.y = pl.y - player.h;
          player.dy = 0;
          player.onGround = true;
          player.jumpCount = 0;
        }
      });
      if (player.y + player.h >= height) {
        player.y = height - player.h;
        player.dy = 0;
        player.onGround = true;
        player.jumpCount = 0;
      }

      // Gate collision to prevent player moving through locked gates
      gates.forEach(g => {
        if (g.locked && rectIntersect(pBox, g)) {
          if (player.dx > 0) player.x = g.x - player.w;
          if (player.dx < 0) player.x = g.x + g.w;
        }
      });

      // Orb collision: check if player collects an orb
      orbs.forEach(o => {
        if (!o.taken && circleRect(o.x, o.y, o.r, pBox)) {
          o.taken = true;
          startQuiz(o.subject, o);
        }
      });
    }

    function draw() {
      ctx.clearRect(0, 0, width, height);
      
      // Draw platforms
      ctx.fillStyle = '#654321';
      platforms.forEach(pl => ctx.fillRect(pl.x, pl.y, pl.w, pl.h));

      // Draw locked gates
      gates.forEach(g => {
        if (!g.locked) return;
        if (g.type === 'fire') {
          ctx.fillStyle = '#f44';
        } else if (g.type === 'ice') {
          ctx.fillStyle = '#4af';
        } else {
          ctx.fillStyle = '#aaa';
        }
        ctx.fillRect(g.x, g.y, g.w, g.h);
      });

      // Draw quiz orbs
      orbs.forEach(o => {
        if (o.taken) return;
        ctx.beginPath(); 
        ctx.arc(o.x, o.y, o.r, 0, Math.PI*2);
        ctx.fillStyle = '#ff0';
        ctx.fill();
      });

      // Draw player
      ctx.fillStyle = '#ff0';
      ctx.fillRect(player.x, player.y, player.w, player.h);

      // Draw HUD: display unlocked abilities
      ctx.fillStyle = '#fff';
      ctx.font = '16px sans-serif';
      const abilities = [];
      if (player.abilities.fire) abilities.push('Fire Blast');
      if (player.abilities.ice) abilities.push('Ice Dash');
      if (player.abilities.doubleJump) abilities.push('Double Jump');
      ctx.fillText('Abilities: ' + (abilities.length ? abilities.join(', ') : 'None'), 10, 20);
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
